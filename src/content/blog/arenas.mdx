---
title: 'Arenas'
pubDate: 2024-08-15
authors: ['jdonszelmann']
reviewers: []
tags: [ "rust"]
description: |
    Sometimes you just really need an arena. Sometimes for performance reasons, other times for lifetime-related reasons.
    In their most basic forms, they're just a vec with some extra guarantees. However, it's those extra guarantees that matter.
    I've found myself looking for the right kind of arena too many times, so here's an overview of literally everything there is. 
    I think, let me know if I forgot something.
draft: false
time: "10 minutes"
---

import Crate from '../../components/Crate.astro';
import ArenaTable from '../../components/ArenaTable.astro';

## properties of arenas

In the table below, I talk about various properties arena do and don't have. 
Sometimes, you might not need an arena at all.
Libraries such as <Crate name="elsa" /> can help you write immutable datastructures,
which could be what you're actually looking for.

In the table, I've abbreviated some things a little, so here is the full explanation:

**Type**

Some arena implementations only allow you to store a single datatype in them.
This can be good for performance, and might make it possible to iterate over the full list of allocations.
However, it can be a limitation too.
If the arena is supposed to work a little like an alternative to the built-in memory allocator, 
then you might want to allocate arbitrary elements of mixed types.
This makes element iteration harder, since elements aren't stored at well-known offsets in the arena.

Interestingly, <Crate name="bumpalo" /> supports both kinds. 
By default, the arena is mixed-type, but you can allocate vectors of a single type in their arena.

**Reuse Memory**

Some arena allocators assume you only allocate, never free.
That might be what you want, but sometimes it might not be.
Most freeing arenas use a linked list of free spots, a freelist,
though there are other options like garbage collection (GC),
and I found one library that can actually compact itself and shrink.

Note, that for performance reasons, shrinking usually isn't often a very good idea.

**Runs Drop**

Especially the mixed-type arenas sometimes don't run `Drop` of stored elements.
It's hard to call `Drop` if you don't know where in the arena elements are stored.
This is a problem if you, for example, want to store an `Rc` in an arena, 
though there are many more types for which this is a problem.

**Iteration**

Although an arena isn't a vec, the items are often stored prety much in-order.
So this column is about whether the arena supports this.
The type behind it indicates whether to iterate you need a reference or mutable reference to the arena.

**Gives Out, and Deref Key**

Some arenas directly give you references,
but some are based on indices, 
and you might even need to have access to the arena to use these indices.
"Gives Out" documents what kind of type you get to refer to an allocation. 
Sometimes it has a `'a` lifetime, refering to the fact that it is bound to the lifetime of the arena.
"Deref Key" documents whether you need access to the arena to use the key, 
or whether the key directly gives access to the element.

**Collections**

A few arena libraries also provide an alternative set of collections like `Vec`, `String`, and pointers like `Box` and `Rc`.

**`no_std` and no `unsafe`**

These should be pretty obvious.

**Concurrent**

This documents whether the arena can be used concurrently. 
For some, I documented whether they require locking.

**Dedup**

Interners often deduplicate keys, to gain pointer equality.
So far I only investigated one library doing this.

**Approach**

This roughly documentes how the library works.

* Linked Arena Chunks means that at a basic level, 
  big chunks of contiguous memory are allocated, 
  slowly filled, and linked together to form one big arena built up from smaller chunks.
* `Vec` (with freelist) refers to the backing storage. 
  An Arena is a `Vec`, and you get indices to later index the `Vec` to get the element you stored.
* Linked List means every element in the arena gets its own link in a linked list.

The others I think mostly make sense.

## Overview

<ArenaTable>

| Crate                                     | Type   | Reuse Mem      | Runs Drop | Iteration | Gives Out         | Deref Key | Collections  | `no_std` | no `unsafe` | concurrent     | dedup |   Approach                                                                                      | Downloads |
| ----------------------------------------- | ------ | -------------- | --------- | --------- | ----------------- | --------- | ------------ | -------- | ----------- | -------------- | ----- | ----------------------------------------------------------------------------------------------- | --------- |
| <Crate name="bumpalo" large />            | Both   | ❌             | ❌        | ❌        | `&'a mut`         | ✅        | ✅           | ✅       | ❌          | ❌             | ❌    | Linked Arena Chunks                                                                             |           |
| <Crate name="typed-arena" large />        | Single | ❌             | ✅        | ✅ `&mut` | `&'a mut`         | ✅        | ❌           | ❌       | ❌          | ❌             | ❌    | Linked Arena Chunks                                                                             |           |
| <Crate name="slotmap" large />            | Single | ✅ freelist    | ✅        | ✅ `&`    | `K: Key`          | ❌        | ❌           | ✅       | ❌          | ❌             | ❌    | `Vec` with Freelist                                                                             |           |
| <Crate name="atree" large />              | Single | ✅ freelist    | ✅        | ✅ `&`    | `Token`           | ❌        | ❌           | ❌       | ✅          | ❌             | ❌    | `Vec`-Backed Linked Tree                                                                        |           |
| <Crate name="generational-arena" large /> | Single | ✅ freelist    | ✅        | ✅ `&`    | `Index`           | ❌        | ❌           | ✅       | ✅          | ❌             | ❌    | `Vec` with Freelist                                                                             |           |
| <Crate name="drop-arena" large />         | Single | ✅ freelist    | ✅        | ❌        | `DropBox<'a>`     | ✅        | ❌           | ❌       | ❌          | ❌             | ❌    | <Crate name="typed-arena"/>+ free list                                                          |           |
| <Crate name="erased-type-arena" large />  | Mixed  | ❌             | ✅        | ❌        | `ArenaMut<'a>`    | ✅        | ❌           | ❌       | ❌          | ❌             | ❌    | Linked List                                                                                     |           |
| <Crate name="typed-arena-nomut" large />  | Single | ❌             | ✅        | ✅ `&`    | `&'a`             | ✅        | ❌           | ❌       | ❌          | ❌             | ❌    | Linked Arena Chunks                                                                             |           |
| <Crate name="gc-arena" large />           | Single | ✅ GC          | ✅        | ❌        | `Gc<'a>`          | ✅        | ❌           | ✅       | ❌          | ❌             | ❌    | [Garbage Collector](https://kyju.org/blog/rust-safe-garbage-collection/)                        |           |
| <Crate name="id-arena" large />           | Single | ❌             | ✅        | ✅ `&`    | `Id`              | ❌        | ❌           | ✅       | ✅          | ✅             | ❌    | `Vec`                                                                                           |           |
| <Crate name="internment" large />         | Single | ❌             | ✅        | ❌        | `ArenaIntern<'a>` | ✅        | ❌           | ❌       | ❌          | 🔒             | ✅    | Hashset of Boxes                                                                                |           |
| <Crate name="concurrent_arena" large />   | Single | ❌             | ❌        | ❌        | `ArenaArc`        | ✅        | ❌           | ❌       | ❌          | ✅ alloc may 🔒| ❌    | Reference Counted Buckets                                                                       |           |
| <Crate name="multi-stash" large />        | Single | ❌             | ✅        | ✅ `&`    | `Key` (usize)     | ✅        | ❌           | ✅       | ❌          | ❌             | ❌    | Indexed `Vec`                                                                                   |           |
| <Crate name="colosseum" large />          | Single | ❌             | ✅        | ❌        | `&'a mut`         | ✅        | ❌           | ❌       | ❌          | 🔒             | ❌    | `Mutex`ed <Crate name="typed-arena" />                                                          |           |
| <Crate name="atomic_arena" large />       | Single | ✅ freelist    | ✅        | ✅ `&`    | `Key`             | ❌        | ❌           | ❌       | ❌          | 🔒             | ❌    | `Vec`[^1]                                                                                       |           |
| <Crate name="slab" large />               | Single | ✅ compact[^2] | ✅        | ✅ `&`    | `usize`           | ❌        | ❌           | ✅       | ✅          | ❌             | ❌    | `Vec`                                                                                           |           |
| <Crate name="sharded-slab" large />       | Single | ✅ freelist    | ✅        | ✅ `&`    | `usize`           | ❌        | ❌           | ❌       | ❌          | ✅             | ❌    | [Linked Arena Chunks](https://docs.rs/sharded-slab/0.1.7/sharded_slab/implementation/index.html)|           |
| <Crate name="bump_scope" large />         | Mixed  | ❌             | ✅        | ❌        | `BumpBox<'a>`     | ✅        | ✅           | ✅       | ❌          | ❌             | ❌    | Linked Arena Chunks[^3]                                                                         |           |
| <Crate name="elise" large />              | Mixed  | ✅ GC          | ✅        | ❌        | `Gc<'a>`          | ✅        | ❌           | ❌       | ❌          | 🔒             | ❌    | Single Global GC                                                                                |           |
| <Crate name="shredder" large />           | Mixed  | ✅ GC          | ✅        | ❌        | `Gc<'a>`          | ✅        | ❌           | ❌       | ❌          | 🔒 (spinlock)  | ❌    | Single Global GC                                                                                |           |


</ArenaTable>

[^1]: Allocating slots in the arena is atomic, but using and storing data into the arena requires `&mut` and the only useful way to use this library across threads is by putting the `Arena` in a `Mutex`
[^2]: Also uses a freelist, but on request can actually reduce its memory size.
[^3]: Surprisingly well-made and documented library compared to its number of downloads. Super well tested too.
